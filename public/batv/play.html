<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <title>Play &mdash; The Bell and the Void</title>

  <link rel="stylesheet" href="lib/glkote.css">
  <link rel="stylesheet" href="lib/dialog.css">

  <style>
    :root {
      --void-900: #0a0a14;
      --void-800: #0f0f1a;
      --void-700: #1a1a2e;
      --void-600: #2a2040;
      --void-500: #3a2d5c;
      --void-400: #4a3f6b;
      --void-300: #6c5ce7;
      --void-200: #7b68ee;
      --void-100: #a29bfe;
      --void-50: #d4d0ff;
      --pink-glow: #ff69b4;
      --text-primary: #e8e6f0;
      --text-secondary: #9b95b0;
      --text-muted: #6b6580;
      --ok: #45d483;
      --header-height: 48px;
      --quickbar-height: 0px;
      --panel-width: 320px;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: var(--void-900);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      text-rendering: optimizeLegibility;
    }

    body {
      position: relative;
    }

    a {
      color: var(--void-100);
      text-decoration: none;
    }

    .topbar {
      position: fixed;
      inset: 0 0 auto 0;
      height: var(--header-height);
      z-index: 90;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      background: linear-gradient(180deg, rgba(26, 26, 46, 0.95), rgba(15, 15, 26, 0.98));
      border-bottom: 1px solid rgba(108, 92, 231, 0.15);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
    }

    .title {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title .bell {
      display: inline-block;
      transform-origin: top center;
      animation: bell-nudge 2.8s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(255, 105, 180, 0.3));
    }

    @keyframes bell-nudge {
      0%, 100% { transform: rotate(0deg); }
      20% { transform: rotate(7deg); }
      40% { transform: rotate(-6deg); }
      60% { transform: rotate(4deg); }
      80% { transform: rotate(-2deg); }
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .top-btn,
    .back-link {
      border: 1px solid rgba(108, 92, 231, 0.2);
      background: rgba(74, 63, 107, 0.16);
      color: var(--text-primary);
      min-height: 36px;
      height: 36px;
      padding: 0 10px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.76rem;
      font-weight: 600;
      line-height: 1;
      cursor: pointer;
      transition: background-color 180ms ease, border-color 180ms ease, transform 140ms ease;
    }

    .top-btn:hover,
    .back-link:hover {
      border-color: rgba(123, 104, 238, 0.5);
      background: rgba(108, 92, 231, 0.24);
    }

    .top-btn:active,
    .back-link:active {
      transform: translateY(1px);
    }

    .count-badge {
      min-width: 32px;
      padding: 2px 6px;
      border-radius: 999px;
      text-align: center;
      font-size: 0.67rem;
      color: var(--void-50);
      background: rgba(108, 92, 231, 0.45);
      border: 1px solid rgba(162, 155, 254, 0.4);
      font-variant-numeric: tabular-nums;
    }

    #gameport {
      position: fixed;
      top: var(--header-height);
      right: 0;
      bottom: var(--quickbar-height);
      left: 0;
      background: radial-gradient(1200px 500px at 70% -10%, rgba(123, 104, 238, 0.08), transparent 40%), var(--void-900);
      color: var(--text-primary);
    }

    #windowport,
    #loadingpane,
    #errorpane {
      position: absolute;
      inset: 0;
      background: transparent;
      color: var(--text-primary);
    }

    #windowport {
      padding: 14px 14px 18px;
    }

    #windowport .WindowFrame,
    #windowport .BufferWindow,
    #windowport .GridWindow,
    #windowport .Window,
    #windowport .Frame,
    #windowport [class*="Window"] {
      background: var(--void-800) !important;
      color: var(--text-primary) !important;
      border-color: rgba(108, 92, 231, 0.2) !important;
    }

    #windowport .BufferWindow,
    #windowport .GridWindow {
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(108, 92, 231, 0.08), 0 8px 30px rgba(0, 0, 0, 0.28);
      overflow: hidden;
    }

    #windowport .BufferLine,
    #windowport .GridLine,
    #windowport span,
    #windowport div {
      color: var(--text-primary);
    }

    #windowport,
    #windowport input,
    #windowport textarea,
    #windowport .BufferLine,
    #windowport .GridLine {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif !important;
      font-size: 1rem !important;
      line-height: 1.7 !important;
    }

    #windowport input,
    #windowport textarea {
      color: var(--void-100) !important;
      caret-color: var(--void-200);
      background: rgba(42, 32, 64, 0.55) !important;
      border: 1px solid rgba(108, 92, 231, 0.34) !important;
      border-radius: 8px !important;
      padding: 7px 9px !important;
    }

    #windowport .Style_input,
    #windowport .style_input,
    #windowport .Input,
    #windowport .InputLine,
    #windowport [class*="input"] {
      color: var(--void-200) !important;
      font-weight: 500 !important;
    }

    #windowport .Style_emphasized,
    #windowport .Style_subheader,
    #windowport .Style_header {
      color: var(--void-50) !important;
    }

    #windowport a,
    #windowport .Style_hyperlink,
    #windowport .Hyperlink,
    #windowport [class*="Hyperlink"] {
      color: var(--void-100) !important;
    }

    #windowport .MorePrompt {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      color: var(--void-50) !important;
      background: rgba(108, 92, 231, 0.9) !important;
      border: 1px solid rgba(162, 155, 254, 0.4);
      box-shadow: 0 4px 12px rgba(108, 92, 231, 0.4);
      font-size: 0.75rem !important;
      letter-spacing: 0.02em;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 15, 26, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(108, 92, 231, 0.36);
      border-radius: 999px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(123, 104, 238, 0.6);
    }

    .panel {
      position: fixed;
      top: var(--header-height);
      right: 0;
      bottom: var(--quickbar-height);
      width: min(var(--panel-width), 92vw);
      z-index: 95;
      transform: translateX(100%);
      transition: transform 300ms ease;
      background: linear-gradient(170deg, rgba(26, 26, 46, 0.98), rgba(15, 15, 26, 0.98));
      border-left: 1px solid rgba(108, 92, 231, 0.2);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      isolation: isolate;
    }

    .panel.open {
      transform: translateX(0);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(108, 92, 231, 0.2);
      background: rgba(15, 15, 26, 0.64);
    }

    .panel-title {
      margin: 0;
      font-size: 0.92rem;
      font-weight: 700;
      color: var(--void-50);
    }

    .panel-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }

    .panel-close {
      border: 1px solid rgba(108, 92, 231, 0.3);
      background: rgba(58, 45, 92, 0.4);
      color: var(--text-primary);
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .panel-content {
      padding: 10px;
      overflow: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .achievement-card,
    .save-card {
      border: 1px solid rgba(108, 92, 231, 0.18);
      border-radius: 12px;
      padding: 10px;
      background: rgba(42, 32, 64, 0.32);
      display: grid;
      gap: 4px;
    }

    .achievement-card {
      grid-template-columns: 36px 1fr auto;
      align-items: center;
    }

    .achievement-card.locked {
      opacity: 0.4;
    }

    .ach-icon {
      width: 32px;
      height: 32px;
      display: grid;
      place-items: center;
      border-radius: 10px;
      background: rgba(108, 92, 231, 0.22);
      font-size: 1rem;
    }

    .ach-name {
      font-size: 0.84rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .ach-desc {
      font-size: 0.74rem;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .ach-time {
      font-size: 0.67rem;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .ach-flag {
      font-size: 0.64rem;
      border-radius: 999px;
      padding: 3px 8px;
      font-weight: 700;
      border: 1px solid rgba(69, 212, 131, 0.6);
      color: #d9ffeb;
      background: rgba(69, 212, 131, 0.2);
      white-space: nowrap;
    }

    .verified {
      border-color: rgba(162, 155, 254, 0.6);
      color: var(--void-50);
      background: rgba(108, 92, 231, 0.28);
    }

    .panel-actions {
      margin-top: 8px;
      display: grid;
      gap: 8px;
    }

    .action-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn {
      appearance: none;
      border: 1px solid rgba(108, 92, 231, 0.35);
      border-radius: 10px;
      background: rgba(58, 45, 92, 0.6);
      color: var(--text-primary);
      min-height: 34px;
      font-size: 0.76rem;
      font-weight: 700;
      padding: 7px 10px;
      cursor: pointer;
      transition: background-color 170ms ease, border-color 170ms ease;
    }

    .btn:hover {
      background: rgba(108, 92, 231, 0.4);
      border-color: rgba(123, 104, 238, 0.66);
    }

    .btn.danger {
      border-color: rgba(255, 105, 180, 0.35);
      background: rgba(255, 105, 180, 0.16);
    }

    .save-card {
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 6px;
    }

    .save-name {
      width: 100%;
      background: rgba(15, 15, 26, 0.8);
      border: 1px solid rgba(108, 92, 231, 0.34);
      border-radius: 8px;
      color: var(--text-primary);
      min-height: 32px;
      padding: 6px 8px;
      font-size: 0.74rem;
    }

    .save-meta {
      font-size: 0.68rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .save-key {
      font-size: 0.64rem;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loading-screen {
      position: fixed;
      inset: var(--header-height) 0 var(--quickbar-height) 0;
      z-index: 100;
      display: grid;
      place-items: center;
      background: radial-gradient(800px 400px at 50% 10%, rgba(108, 92, 231, 0.14), transparent 45%), var(--void-900);
      transition: opacity 320ms ease, visibility 320ms ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loading-core {
      text-align: center;
      color: var(--text-secondary);
      letter-spacing: 0.02em;
    }

    .loading-bell {
      font-size: 2.2rem;
      margin-bottom: 8px;
      display: inline-block;
      transform-origin: top center;
      animation: bell-swing 1.8s ease-in-out infinite;
      text-shadow: 0 0 25px rgba(255, 105, 180, 0.35);
    }

    @keyframes bell-swing {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(12deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(8deg); }
    }

    .loading-text {
      font-size: 1rem;
      animation: pulse 1.4s ease-in-out infinite;
      color: var(--void-50);
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(var(--quickbar-height) + 18px);
      transform: translate(-50%, 22px);
      z-index: 110;
      background: var(--void-600);
      border: 1px solid var(--void-300);
      border-radius: 12px;
      box-shadow: var(--shadow);
      color: var(--text-primary);
      padding: 10px 14px;
      min-width: 240px;
      max-width: 90vw;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease, transform 220ms ease;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .toast-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--void-50);
    }

    .toast-sub {
      margin-top: 2px;
      font-size: 0.72rem;
      color: var(--text-secondary);
    }

    .quickbar {
      display: none;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 40px;
      z-index: 92;
      border-top: 1px solid rgba(108, 92, 231, 0.15);
      background: rgba(15, 15, 26, 0.95);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 0 8px;
      overflow-x: auto;
      white-space: nowrap;
    }

    .quickbar .qbtn {
      border: 1px solid rgba(108, 92, 231, 0.3);
      background: rgba(58, 45, 92, 0.45);
      color: var(--text-secondary);
      border-radius: 999px;
      font-size: 0.75rem;
      line-height: 1;
      min-height: 28px;
      padding: 6px 10px;
      cursor: pointer;
      transition: background-color 140ms ease, color 140ms ease;
    }

    .quickbar .qbtn:hover {
      color: var(--text-primary);
      background: rgba(108, 92, 231, 0.4);
    }

    .panel-overlay {
      position: fixed;
      inset: var(--header-height) 0 var(--quickbar-height) 0;
      z-index: 94;
      opacity: 0;
      pointer-events: none;
      background: rgba(10, 10, 20, 0.42);
      transition: opacity 220ms ease;
    }

    .panel-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .DialogLayer,
    .DialogOverlay,
    .DialogPane,
    .DialogBox,
    .DialogFrame {
      background-color: rgba(10, 10, 20, 0.9) !important;
      color: var(--text-primary) !important;
      border-color: rgba(108, 92, 231, 0.45) !important;
    }

    .DialogButton,
    .DialogButton:link,
    .DialogButton:visited,
    button[id*="dialog"],
    input[id*="dialog"] {
      background: rgba(108, 92, 231, 0.35) !important;
      border: 1px solid rgba(108, 92, 231, 0.65) !important;
      color: var(--void-50) !important;
    }

    .DialogTextInput,
    input[type="text"].DialogInput {
      background: var(--void-700) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(108, 92, 231, 0.45) !important;
    }

    @media (min-width: 768px) {
      :root {
        --quickbar-height: 40px;
      }

      .quickbar {
        display: flex;
      }
    }

    @media (max-width: 767px) {
      .title {
        max-width: 45vw;
      }

      .top-btn,
      .back-link {
        padding: 0 8px;
      }

      .top-btn .label,
      .back-link .label {
        display: none;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 1ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 1ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>

  <script src="lib/jquery-1.12.4.min.js"></script>
  <script src="lib/glkote.min.js"></script>
  <script src="lib/quixe.min.js"></script>
  <script src="lib/dialog.js"></script>

  <script>
    var game_options = {
      default_story: '/batv/story.ulx',
      set_page_title: false,
      do_vm_autosave: true,
      spacing: 4
    };
  </script>
</head>
<body>
  <header class="topbar">
    <div class="title"><span class="bell" aria-hidden="true">üîî</span><span>The Bell and the Void</span></div>
    <div class="topbar-actions">
      <button class="top-btn" id="toggleAchievements" type="button" aria-label="Toggle achievements panel"><span>üèÜ</span><span class="label">Achievements</span><span class="count-badge" id="achievementCount">0/12</span></button>
      <button class="top-btn" id="toggleSaves" type="button" aria-label="Toggle save panel"><span>üíæ</span><span class="label">Saves</span></button>
      <a class="back-link" href="/bell-and-the-void"><span>‚Üê</span><span class="label">Back to site</span></a>
    </div>
  </header>

  <div id="gameport" aria-live="polite">
    <div id="windowport"></div>
    <div id="loadingpane"></div>
    <div id="errorpane"></div>
  </div>

  <div class="panel-overlay" id="panelOverlay" aria-hidden="true"></div>

  <aside class="panel" id="achievementPanel" aria-hidden="true">
    <div class="panel-header">
      <div>
        <h2 class="panel-title">Achievements</h2>
        <div class="panel-meta" id="achievementMeta">0 unlocked</div>
      </div>
      <button class="panel-close" id="closeAchievements" type="button" aria-label="Close achievements panel">√ó</button>
    </div>
    <div class="panel-content" id="achievementList"></div>
    <div class="panel-content" style="padding-top:0;">
      <div class="panel-actions">
        <button class="btn" id="exportProofs" type="button">Export Proofs</button>
      </div>
    </div>
  </aside>

  <aside class="panel" id="savePanel" aria-hidden="true">
    <div class="panel-header">
      <div>
        <h2 class="panel-title">Save and Load</h2>
        <div class="panel-meta" id="autosaveStatus">Autosave enabled</div>
      </div>
      <button class="panel-close" id="closeSaves" type="button" aria-label="Close save panel">√ó</button>
    </div>
    <div class="panel-content">
      <div class="action-row">
        <button class="btn" id="quickSaveBtn" type="button">Quick Save</button>
        <button class="btn" id="quickLoadBtn" type="button">Quick Load</button>
      </div>
      <button class="btn danger" id="clearAllSaves" type="button">Clear All Saves</button>
      <div class="panel-meta" id="saveMetaSummary">No saves detected</div>
      <div id="saveList"></div>
    </div>
  </aside>

  <div class="loading-screen" id="loadingScreen" role="status" aria-live="polite">
    <div class="loading-core">
      <div class="loading-bell" aria-hidden="true">üîî</div>
      <div class="loading-text">Loading The Bell and the Void...</div>
    </div>
  </div>

  <div class="toast" id="achievementToast" role="status" aria-live="assertive"></div>

  <nav class="quickbar" aria-label="Quick commands">
    <button class="qbtn" type="button" data-cmd="look">Look</button>
    <button class="qbtn" type="button" data-cmd="inventory">Inventory</button>
    <button class="qbtn" type="button" data-cmd="ring bell">Ring Bell</button>
    <button class="qbtn" type="button" data-cmd="observe">Observe</button>
    <button class="qbtn" type="button" data-cmd="dodge">Dodge</button>
    <button class="qbtn" type="button" data-cmd="deflect">Deflect</button>
    <button class="qbtn" type="button" data-cmd="talk">Talk</button>
    <button class="qbtn" type="button" data-cmd="help">Help</button>
  </nav>

  <script>
    (function () {
      var ACHIEVEMENTS = {
        first_look: { name: 'Awakening', desc: 'Survey your surroundings for the first time', icon: 'üëÅ' },
        enter_forge: { name: 'Forge-Born', desc: 'Enter the Monastery Forge', icon: 'üî•' },
        enter_bell_tower: { name: 'Tower Ascent', desc: 'Reach the Bell Tower', icon: 'üóº' },
        first_ring: { name: 'First Resonance', desc: 'Ring a bell for the first time', icon: 'üîî' },
        first_combat: { name: 'Clash of Frequencies', desc: 'Enter combat', icon: '‚öî' },
        first_observe: { name: 'Keen Eye', desc: 'Observe an enemy', icon: 'üîç' },
        first_deflect: { name: 'Ward Master', desc: 'Deflect an attack', icon: 'üõ°' },
        break_poise: { name: 'Resonance Break', desc: 'Break an enemy poise', icon: 'üí•' },
        deathblow: { name: 'Silence the Echo', desc: 'Deliver a deathblow', icon: 'üó°' },
        defeat_shade: { name: 'Shade Silenced', desc: 'Defeat the Hush Shade', icon: 'üëª' },
        defeat_colossus: { name: 'Colossus Fallen', desc: 'Defeat the Iron Colossus', icon: 'üèõ' },
        talk_npc: { name: 'Echo Listener', desc: 'Have a conversation', icon: 'üí¨' }
      };

      var TRIGGERS = {
        first_look: /you see|you are in|Lower Courtyard|Great Hall/i,
        enter_forge: /Monastery Forge|the forge|anvil.*glowing/i,
        enter_bell_tower: /Bell Tower|tower.*bells.*hang/i,
        first_ring: /ring.*bell|bell.*rings|tone.*fills|resonance.*spreads/i,
        first_combat: /combat begins|enters combat|telegraph/i,
        first_observe: /you observe|you notice.*pattern|perception.*reveals/i,
        first_deflect: /deflect|ward.*holds|bell.*deflects/i,
        break_poise: /poise.*breaks|poise.*shattered|staggers/i,
        deathblow: /deathblow|finishing strike|final tone/i,
        defeat_shade: /shade.*defeated|shade.*dissolves|shade.*silenced/i,
        defeat_colossus: /colossus.*defeated|colossus.*falls|colossus.*crumbles/i,
        talk_npc: /echo conversation|speaks|tells you|asks you/i
      };

      var STORAGE_KEY = 'batv_achievements_v1';
      var SAVE_META_KEY = 'batv_save_meta_v1';
      var SESSION_ID_KEY = 'batv_session_id';
      var LAST_AUTOSAVE_KEY = 'batv_last_autosave';
      var state = {
        signing: null,
        achievements: loadAchievements(),
        saveMeta: loadSaveMeta(),
        scanOffset: 0,
        loadingHidden: false,
        toastTimer: null
      };
      var sessionId = sessionStorage.getItem(SESSION_ID_KEY) || createSessionId();

      function createSessionId() {
        var id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'session-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        sessionStorage.setItem(SESSION_ID_KEY, id);
        return id;
      }

      function loadAchievements() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            return { unlocked: {} };
          }
          var parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object' || !parsed.unlocked) {
            return { unlocked: {} };
          }
          return parsed;
        } catch (err) {
          return { unlocked: {} };
        }
      }

      function saveAchievements() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.achievements));
      }

      function loadSaveMeta() {
        try {
          var raw = localStorage.getItem(SAVE_META_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (err) {
          return {};
        }
      }

      function saveSaveMeta() {
        localStorage.setItem(SAVE_META_KEY, JSON.stringify(state.saveMeta));
      }

      function encodeB64Url(arrayBuffer) {
        var bytes = new Uint8Array(arrayBuffer);
        var binary = '';
        for (var i = 0; i < bytes.length; i += 1) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
      }

      async function getOrCreateKeys() {
        var storedPrivate = sessionStorage.getItem('batv_signing_key');
        var storedPublic = localStorage.getItem('batv_public_key');
        if (storedPrivate && storedPublic && window.crypto && crypto.subtle) {
          var privateJwk = JSON.parse(storedPrivate);
          return {
            privateKey: await crypto.subtle.importKey('jwk', privateJwk, { name: 'ECDSA', namedCurve: 'P-256' }, false, ['sign']),
            publicKeyJwk: JSON.parse(storedPublic)
          };
        }

        if (!(window.crypto && crypto.subtle)) {
          return { privateKey: null, publicKeyJwk: null };
        }

        var keyPair = await crypto.subtle.generateKey({ name: 'ECDSA', namedCurve: 'P-256' }, true, ['sign', 'verify']);
        var privateJwkExport = await crypto.subtle.exportKey('jwk', keyPair.privateKey);
        var publicJwk = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
        sessionStorage.setItem('batv_signing_key', JSON.stringify(privateJwkExport));
        localStorage.setItem('batv_public_key', JSON.stringify(publicJwk));
        return { privateKey: keyPair.privateKey, publicKeyJwk: publicJwk };
      }

      async function signAchievement(payload, privateKey) {
        if (!(privateKey && window.crypto && crypto.subtle)) {
          return null;
        }
        var body = JSON.stringify(payload);
        var data = new TextEncoder().encode(body);
        var signature = await crypto.subtle.sign({ name: 'ECDSA', hash: { name: 'SHA-256' } }, privateKey, data);
        return encodeB64Url(signature);
      }

      function formatTime(ts) {
        if (!ts) {
          return 'Unknown time';
        }
        try {
          return new Date(ts).toLocaleString();
        } catch (err) {
          return String(ts);
        }
      }

      function unlockedCount() {
        return Object.keys(state.achievements.unlocked).length;
      }

      function hideLoadingScreen() {
        if (state.loadingHidden) {
          return;
        }
        var loading = document.getElementById('loadingScreen');
        if (loading) {
          loading.classList.add('hidden');
        }
        state.loadingHidden = true;
      }

      function showToast(achievement) {
        var toast = document.getElementById('achievementToast');
        if (!toast) {
          return;
        }
        toast.innerHTML = '<div class="toast-title">' + achievement.icon + ' ' + achievement.name + ' - Achievement Unlocked!</div>' +
          '<div class="toast-sub">The bell remembers your resonance.</div>';
        toast.classList.add('show');
        clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(function () {
          toast.classList.remove('show');
        }, 3000);
      }

      function renderAchievements() {
        var list = document.getElementById('achievementList');
        var count = unlockedCount();
        var total = Object.keys(ACHIEVEMENTS).length;
        document.getElementById('achievementCount').textContent = count + '/' + total;
        document.getElementById('achievementMeta').textContent = count + ' unlocked';

        if (!list) {
          return;
        }

        var html = '';
        Object.keys(ACHIEVEMENTS).forEach(function (id) {
          var def = ACHIEVEMENTS[id];
          var unlock = state.achievements.unlocked[id];
          var locked = !unlock;
          html += '<article class="achievement-card ' + (locked ? 'locked' : 'unlocked') + '">';
          html += '<div class="ach-icon" aria-hidden="true">' + def.icon + '</div>';
          html += '<div>';
          html += '<div class="ach-name">' + def.name + '</div>';
          html += '<div class="ach-desc">' + (locked ? '???' : def.desc) + '</div>';
          html += '<div class="ach-time">' + (locked ? '' : formatTime(unlock.unlockedAt)) + '</div>';
          html += '</div>';
          if (locked) {
            html += '<div class="ach-flag" style="visibility:hidden;">Locked</div>';
          } else {
            html += '<div>';
            html += '<div class="ach-flag">‚úì Unlocked</div>';
            if (unlock.signature) {
              html += '<div class="ach-flag verified" style="margin-top:4px;">Verified</div>';
            }
            html += '</div>';
          }
          html += '</article>';
        });

        list.innerHTML = html;
      }

      async function unlockAchievement(id) {
        if (!ACHIEVEMENTS[id] || state.achievements.unlocked[id]) {
          return;
        }
        var def = ACHIEVEMENTS[id];
        var payload = {
          id: id,
          name: def.name,
          unlockedAt: Date.now(),
          gameSession: sessionId
        };
        var signature = null;
        if (state.signing && state.signing.privateKey) {
          try {
            signature = await signAchievement(payload, state.signing.privateKey);
          } catch (err) {
            signature = null;
          }
        }
        state.achievements.unlocked[id] = {
          id: payload.id,
          name: payload.name,
          icon: def.icon,
          desc: def.desc,
          unlockedAt: payload.unlockedAt,
          gameSession: payload.gameSession,
          signature: signature
        };
        saveAchievements();
        renderAchievements();
        showToast(def);
      }

      function collectGameText() {
        var root = document.getElementById('windowport');
        if (!root) {
          return '';
        }
        var targets = root.querySelectorAll('.BufferWindow, .GridWindow');
        var combined = '';
        for (var i = 0; i < targets.length; i += 1) {
          combined += '\n' + targets[i].textContent;
        }
        return combined;
      }

      function parseTriggers(text) {
        Object.keys(TRIGGERS).forEach(function (id) {
          if (!state.achievements.unlocked[id] && TRIGGERS[id].test(text)) {
            unlockAchievement(id);
          }
        });
      }

      function scanForAchievementsAndLoading() {
        var allText = collectGameText();
        if (!allText) {
          return;
        }
        if (allText.trim().length > 0) {
          hideLoadingScreen();
        }
        if (allText.length < state.scanOffset) {
          state.scanOffset = 0;
        }
        var fresh = allText.slice(state.scanOffset);
        if (fresh.length > 0) {
          parseTriggers(fresh);
        }
        state.scanOffset = allText.length;
      }

      function observeGameOutput() {
        var root = document.getElementById('windowport');
        if (!root) {
          return;
        }
        var observer = new MutationObserver(function () {
          scanForAchievementsAndLoading();
        });
        observer.observe(root, { childList: true, subtree: true, characterData: true });
      }

      function sendCommand(cmd) {
        var input = document.querySelector('.BufferWindow input, .GridWindow input');
        if (input) {
          input.focus();
          input.value = cmd;
          var e = $.Event('keydown');
          e.which = 13;
          e.keyCode = 13;
          $(input).trigger(e);
        }
      }

      function wireQuickCommands() {
        var quickButtons = document.querySelectorAll('.qbtn[data-cmd]');
        for (var i = 0; i < quickButtons.length; i += 1) {
          quickButtons[i].addEventListener('click', function (ev) {
            sendCommand(ev.currentTarget.getAttribute('data-cmd'));
          });
        }
      }

      function openPanel(which) {
        var achievementPanel = document.getElementById('achievementPanel');
        var savePanel = document.getElementById('savePanel');
        var overlay = document.getElementById('panelOverlay');
        var showAchievements = which === 'achievements';
        achievementPanel.classList.toggle('open', showAchievements);
        savePanel.classList.toggle('open', !showAchievements);
        achievementPanel.setAttribute('aria-hidden', showAchievements ? 'false' : 'true');
        savePanel.setAttribute('aria-hidden', showAchievements ? 'true' : 'false');
        overlay.classList.add('show');
      }

      function closePanels() {
        var achievementPanel = document.getElementById('achievementPanel');
        var savePanel = document.getElementById('savePanel');
        var overlay = document.getElementById('panelOverlay');
        achievementPanel.classList.remove('open');
        savePanel.classList.remove('open');
        achievementPanel.setAttribute('aria-hidden', 'true');
        savePanel.setAttribute('aria-hidden', 'true');
        overlay.classList.remove('show');
      }

      function storageKeys() {
        var keys = [];
        for (var i = 0; i < localStorage.length; i += 1) {
          var key = localStorage.key(i);
          if (key && key.indexOf('DialogStorage_') === 0) {
            keys.push(key);
          }
        }
        keys.sort();
        return keys;
      }

      function inferAutosave(keys) {
        var now = Date.now();
        for (var i = 0; i < keys.length; i += 1) {
          if (/auto/i.test(keys[i])) {
            localStorage.setItem(LAST_AUTOSAVE_KEY, String(now));
            break;
          }
        }
      }

      function renderSaveList() {
        var keys = storageKeys();
        inferAutosave(keys);
        var list = document.getElementById('saveList');
        var summary = document.getElementById('saveMetaSummary');
        var autosave = document.getElementById('autosaveStatus');
        var autosaveTs = Number(localStorage.getItem(LAST_AUTOSAVE_KEY) || 0);
        autosave.textContent = game_options.do_vm_autosave ? ('Autosave enabled' + (autosaveTs ? ' ‚Ä¢ last seen ' + formatTime(autosaveTs) : '')) : 'Autosave disabled';

        if (!keys.length) {
          summary.textContent = 'No saves detected';
          list.innerHTML = '';
          return;
        }

        summary.textContent = keys.length + ' save' + (keys.length === 1 ? '' : 's') + ' detected';
        var html = '';
        keys.forEach(function (key, idx) {
          var value = localStorage.getItem(key);
          var meta = state.saveMeta[key] || {};
          if (!meta.name) {
            meta.name = 'Slot ' + (idx + 1);
          }
          if (!meta.updatedAt) {
            meta.updatedAt = Date.now();
          }
          state.saveMeta[key] = meta;
          var size = value ? value.length : 0;
          html += '<article class="save-card" data-key="' + key + '">';
          html += '<div>';
          html += '<input class="save-name" data-save-name="' + key + '" value="' + escapeHtml(meta.name) + '" aria-label="Save slot name">';
          html += '<div class="save-meta">Updated ' + formatTime(meta.updatedAt) + ' ‚Ä¢ ' + size + ' bytes</div>';
          html += '<div class="save-key">' + key + '</div>';
          html += '</div>';
          html += '<button class="btn" type="button" data-delete-save="' + key + '">Delete</button>';
          html += '</article>';
        });
        list.innerHTML = html;
        saveSaveMeta();
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function wirePanels() {
        document.getElementById('toggleAchievements').addEventListener('click', function () {
          var panel = document.getElementById('achievementPanel');
          if (panel.classList.contains('open')) {
            closePanels();
          } else {
            openPanel('achievements');
          }
        });
        document.getElementById('toggleSaves').addEventListener('click', function () {
          var panel = document.getElementById('savePanel');
          renderSaveList();
          if (panel.classList.contains('open')) {
            closePanels();
          } else {
            openPanel('saves');
          }
        });
        document.getElementById('closeAchievements').addEventListener('click', closePanels);
        document.getElementById('closeSaves').addEventListener('click', closePanels);
        document.getElementById('panelOverlay').addEventListener('click', closePanels);
      }

      function wireSaveControls() {
        document.getElementById('quickSaveBtn').addEventListener('click', function () {
          sendCommand('SAVE');
          setTimeout(renderSaveList, 1200);
        });

        document.getElementById('quickLoadBtn').addEventListener('click', function () {
          sendCommand('RESTORE');
          setTimeout(renderSaveList, 1200);
        });

        document.getElementById('clearAllSaves').addEventListener('click', function () {
          if (!window.confirm('Clear all local save slots for this game?')) {
            return;
          }
          var keys = storageKeys();
          keys.forEach(function (key) {
            localStorage.removeItem(key);
            delete state.saveMeta[key];
          });
          saveSaveMeta();
          renderSaveList();
        });

        document.getElementById('saveList').addEventListener('input', function (ev) {
          var target = ev.target;
          var key = target.getAttribute('data-save-name');
          if (!key) {
            return;
          }
          state.saveMeta[key] = state.saveMeta[key] || {};
          state.saveMeta[key].name = target.value.trim() || 'Unnamed Slot';
          state.saveMeta[key].updatedAt = Date.now();
          saveSaveMeta();
        });

        document.getElementById('saveList').addEventListener('click', function (ev) {
          var key = ev.target.getAttribute('data-delete-save');
          if (!key) {
            return;
          }
          localStorage.removeItem(key);
          delete state.saveMeta[key];
          saveSaveMeta();
          renderSaveList();
        });
      }

      function wireExport() {
        document.getElementById('exportProofs').addEventListener('click', function () {
          var data = {
            game: 'The Bell and the Void',
            exportedAt: Date.now(),
            publicKey: state.signing ? state.signing.publicKeyJwk : JSON.parse(localStorage.getItem('batv_public_key') || 'null'),
            achievements: state.achievements.unlocked
          };
          var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'batv-achievement-proofs-' + Date.now() + '.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }

      function pollForSaveChanges() {
        var previous = storageKeys().join('|');
        setInterval(function () {
          var next = storageKeys().join('|');
          if (next !== previous) {
            previous = next;
            renderSaveList();
          }
        }, 1800);
      }

      function init() {
        wirePanels();
        wireQuickCommands();
        wireSaveControls();
        wireExport();
        observeGameOutput();
        renderAchievements();
        renderSaveList();
        pollForSaveChanges();
        scanForAchievementsAndLoading();
        getOrCreateKeys()
          .then(function (keys) {
            state.signing = keys;
            renderAchievements();
          })
          .catch(function () {
            state.signing = { privateKey: null, publicKeyJwk: null };
            renderAchievements();
          });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
